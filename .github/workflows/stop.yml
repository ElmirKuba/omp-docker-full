name: üõë Manual Stop Containers with Env and Branch

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '–í—ã–±–µ—Ä–∏ –≤–µ—Ç–∫—É (–∏–∑ Git), –∏–∑ –∫–æ—Ç–æ—Ä–æ–π –≤–∑—è—Ç—å stop_docker.sh'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - rc
          - develop

      environment:
        description: '–í—ã–±–µ—Ä–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ'
        required: true
        default: 'prod7777'
        type: choice
        options:
          - prod7777
          - stage5555
          - dev1111

jobs:
  stop:
    runs-on: ubuntu-latest
    steps:
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ stop_docker.sh –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ –í–î–°
        env:
          VDS_USER: ${{ secrets.VDS_USER }}
          VDS_IP: ${{ secrets.VDS_IP }}
          VDS_PASSWORD: ${{ secrets.VDS_PASSWORD }}
          STOP_BRANCH: ${{ github.event.inputs.branch }}
          DEPLOY_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo "üõë –û–±–Ω–æ–≤–ª—è–µ–º stop_docker.sh –∏–∑ –≤–µ—Ç–∫–∏ $STOP_BRANCH –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
          sshpass -p "$VDS_PASSWORD" ssh -o StrictHostKeyChecking=no "$VDS_USER@$VDS_IP" << EOF
            set -euo pipefail

            REPO_DIR="/home/deploy/${DEPLOY_ENV}"

            # –ï—Å–ª–∏ –µ—â—ë –Ω–µ—Ç –∫–ª–æ–Ω–∞ ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            if [ ! -d "\$REPO_DIR/.git" ]; then
              echo "üìÅ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ \$REPO_DIR"
              mkdir -p "\$REPO_DIR"
              cd "\$REPO_DIR"
              git init
              git remote add origin git@github.com:ElmirKuba/omp-docker-full.git
            else
              cd "\$REPO_DIR"
            fi

          echo "üîÑ Fetch origin/$STOP_BRANCH (shallow)"
          git fetch origin "$STOP_BRANCH" --depth=1

          echo "üì• –í—ã—Ç—è–≥–∏–≤–∞–µ–º stop_docker.sh"
          git show "origin/$STOP_BRANCH":stop_docker.sh > /home/deploy/stop_docker.sh
          chmod +x /home/deploy/stop_docker.sh

          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º stop_docker.sh"
          DEPLOY_ENV=${DEPLOY_ENV} bash /home/deploy/stop_docker.sh

          echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ $DEPLOY_ENV –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
          EOF
